# AI 首饰文字定制系统

## 技术需求与实现方案（完整版）

---

## 1. 项目目标（Goal）

构建一个 **Web 端 AI 首饰定制系统**，允许用户：

* 在首饰底图上输入文字（画布外输入）
* 实时看到 2D 预览效果
* 自由拖拽、缩放、旋转文字与装饰
* 系统自动保证 **文字可被真实加工为金属首饰**
* 输出 **可生产的几何数据**（而非仅效果图）

**核心目标不是“好看”，而是：**

> 所见即所得 + 所见即能生产

---

## 2. 工艺约束总览（Manufacturing Constraints）

### 2.1 支持工艺

| 工艺类型 | 用途        | 核心约束      |
| ---- | --------- | --------- |
| 金属切割 | 吊坠、铭牌、空切字 | kerf、最小连桥 |
| 金属蚀刻 | 薄片铭文、图案   | 最小特征尺寸    |

---

### 2.2 核心制造规则（抽象化）

系统必须保证：

1. **文字整体连通**

   * 整段文字（或设计指定的文字组）必须形成**单一连通体**
   * 不允许“孤立岛”（加工后会掉件）

2. **最小结构尺寸**

   * 任意连桥 / 笔画厚度 ≥ 工艺最小值
   * 任意间隙 ≥ 工艺最小可保留间隙

---

## 3. 工艺参数模型（可配置）

### 3.1 金属切割（Laser / CNC）

| 参数              | 含义       | 推荐默认               |
| --------------- | -------- | ------------------ |
| `kerf_mm`       | 切缝宽度     | 0.2 – 0.4 mm       |
| `min_bridge_mm` | 最小连桥宽度   | max(2×kerf, 0.8mm) |
| `min_gap_mm`    | 最小间隙     | ≥ 0.5 mm           |
| `max_offset_mm` | 最大允许字体增粗 | 0.4 – 0.6 mm       |

---

### 3.2 金属蚀刻（Photo Etching）

| 参数                   | 含义   | 规则               |
| -------------------- | ---- | ---------------- |
| `metal_thickness_mm` | 金属厚度 | 必填               |
| `min_feature_mm`     | 最小特征 | max(厚度, 0.1mm)   |
| `min_bridge_mm`      | 最小连桥 | ≥ min_feature_mm |
| `etch_tolerance`     | 工艺误差 | ±10% thickness   |

---

### 3.3 统一配置结构（示例）

```json
{
  "process": "cut",
  "metal_thickness_mm": 0.5,
  "kerf_mm": 0.3,
  "min_bridge_mm": 1.0,
  "min_feature_mm": 1.0,
  "bridge_max_gap_mm": 2.5,
  "max_offset_mm": 0.5,
  "flatten_tolerance_mm": 0.05,
  "safety_factor": 1.15
}
```

---

## 4. 系统总体架构

```
┌──────────────┐
│ UI 输入层     │  ← 文本、字体、字距
└─────┬────────┘
      │
┌─────▼────────┐
│ 实时预览层     │  Canvas Text（快）
│ Konva/Fabric │
└─────┬────────┘
      │ debounce
┌─────▼────────┐
│ 制造几何层     │  字形 → 轮廓 → 修复
│ Font + Clipper│
└─────┬────────┘
      │
┌─────▼────────┐
│ 生产预览层     │  SVG Path
└─────┬────────┘
      │
┌─────▼────────┐
│ 数据持久化     │ JSON + SVG
└──────────────┘
```

---

## 5. 前端交互层设计

### 5.1 文字输入策略（关键）

* ❌ 不在画布内编辑
* ✅ 外部输入框（Input / Textarea）
* 每次输入 → 更新画布中文字对象

```text
Input Change
   ↓
Update Text Node
   ↓
Canvas Redraw (即时)
```

---

### 5.2 画布能力要求

| 能力 | 说明           |
| -- | ------------ |
| 拖拽 | 文本 / 装饰      |
| 缩放 | 等比 / 限制最小    |
| 旋转 | 任意角度         |
| 边界 | 限制在可刻字区域     |
| 层级 | 底图 / 文字 / 装饰 |

---

### 5.3 可刻字区域（Print Area）

* 类型：

  * 矩形（第一期）
  * 多边形 / Path（第二期）
* 行为：

  * 拖拽结束后自动 clamp
  * 不允许超出区域

---

## 6. 字体与几何处理核心流程（重点）

### 6.1 文字 → 轮廓

1. 加载字体文件（TTF/OTF）
2. 将字符串排版为 glyph run
3. 获取每个 glyph 的 path
4. 合并 glyph path → 初始文字轮廓

---

### 6.2 曲线扁平化（Flatten）

* 贝塞尔 → 多边形
* 误差 ≤ `flatten_tolerance_mm`
* 目的：供布尔运算使用

---

## 7. 自动修复算法设计（核心）

### 7.1 修复策略总览（顺序执行）

```
原始轮廓
  ↓
Union（是否连通？）
  ↓ 否
减字距
  ↓ 否
桥接（Bridge）
  ↓
增粗（Offset）
  ↓
合格检测
```

---

### 7.2 修复 A：字体增粗（Offset）

* 对整体轮廓做 outward offset
* 目标：

  * min_stroke ≥ min_feature_mm
* 约束：

  * offset ≤ max_offset_mm

---

### 7.3 修复 B：桥接（Bridging）

**触发条件**

* 相邻连通分量距离 ≤ bridge_max_gap_mm

**桥结构**

* 形状：胶囊形（圆角矩形）
* 宽度：min_bridge_mm
* 与原字形做 union

**优势**

* 结构强度高
* 风格破坏最小
* 工艺可解释

---

## 8. 制造可行性检测（验收）

### 8.1 连通性检测

* union 后应为：

  * 1 个多边形（或指定数量）
* 否则 → 不合格

---

### 8.2 最小厚度检测（工程可行）

**负 offset 测试**

* 对轮廓做 inward offset = min_feature_mm / 2
* 若断裂或消失 → 存在薄弱区 → 不合格

---

## 9. 渲染策略（性能关键）

### 9.1 双层渲染

| 层级    | 目的      |
| ----- | ------- |
| 快速预览层 | 输入/拖拽实时 |
| 制造预览层 | 可生产形态   |

### 9.2 更新节奏

* 输入时：仅更新 Text
* debounce 300ms：

  * 跑完整几何修复
  * 更新 SVG Path 覆盖层

---

## 10. 数据模型（可继续编辑）

### 10.1 设计 JSON（示例）

```json
{
  "designId": "D2026XXXX",
  "process": "cut",
  "font": {
    "family": "Cinzel",
    "url": "...",
    "size": 72,
    "letterSpacing": 2
  },
  "text": "ALVIN",
  "transform": {
    "x": 520,
    "y": 480,
    "scale": 1,
    "rotation": 0
  },
  "manufacturingRules": {
    "min_bridge_mm": 1.0,
    "min_feature_mm": 1.0
  }
}
```

---

### 10.2 生产输出

| 类型       | 用途      |
| -------- | ------- |
| SVG Path | 切割 / 蚀刻 |
| PNG/WebP | 下单预览    |
| JSON     | 继续编辑    |

---

## 11. 异常与回退策略（产品级）

| 情况   | 行为          |
| ---- | ----------- |
| 无法连通 | 自动桥接        |
| 过度增粗 | 提示换字体       |
| 字距过大 | 自动压缩        |
| 仍不合格 | 阻止下单 + 明确提示 |

**提示文案示例：**

> 当前字体在所选工艺下结构强度不足
> 建议：
> • 增大字号
> • 减少字间距
> • 选择推荐字体

---

## 12. 技术选型总结

| 模块   | 技术                |
| ---- | ----------------- |
| 画布交互 | Konva / Fabric    |
| 字体解析 | Fontkit           |
| 几何布尔 | Clipper（JS/WASM）  |
| 数据   | JSON + SVG        |
| 导出   | 高倍率 Canvas + Path |

---

## 13. 开发任务拆分建议

### Phase 1（MVP）

* 实时输入 + 拖拽
* 字形轮廓化
* Offset 修复
* 单一工艺（切割）

### Phase 2

* 桥接算法
* 蚀刻支持
* 负 offset 验收
* 制造预览层

### Phase 3

* 多边形刻字区域
* 字体预设库
* AI 字体推荐（可制造优先）

---

## 14. 一句话结论

> **这是一个“制造约束驱动”的图形系统，不是普通前端渲染问题。**

只要你严格按照：

* **轮廓化**
* **几何修复**
* **工艺验收**

来实现，这套方案可以稳定支撑 **真实金属切割与蚀刻首饰量产**。
